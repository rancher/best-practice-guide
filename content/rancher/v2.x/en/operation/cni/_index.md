---
title: CNI Network Provider
weight: 2300
draft: true
---

--- 

### Introduction

CNI (Container Network Interface), a [Cloud Native Computing Foundation project](https://cncf.io/), consists of a specification and libraries for writing plugins to configure network interfaces in Linux containers, along with a number of supported plugins. CNI concerns itself only with network connectivity of containers and removing allocated resources when the container is deleted.

K8S uses CNI as an interface between network providers and k8s pods networking.

<img src="img/cni-logo.png" alt="CNI logo">

For more information visit [CNI GitHub project](https://github.com/containernetworking/cni). 


### Network model

Basically, CNI providers offer 2 kinds of network model depending on architecture:

#### Encapsulated 

This kind of network model generates an overlay layer 2 network encapsulated over layer 3 network (k8s cluster workers). With this model you have an isolated layer 2 network for containers without needed routing distribution, at the cost of an little overhead in terms of processing and increasing ip package size with an ip header generated by overlay encapsulation. Encapsulation information is used to be distributed by udp port between k8s workers, interchanging network control plane information about how mac addressed could be reached. Common encapsulation used in this kind of network model are vxlan, ipsec, ip-in-ip...

Simplifying, this network model generates a kind of network bridge extended between k8s workers, where pods will be connected.

This network model is indeed when a extended layer 2 bridge is preferred. This network model is sensible to layer 3 network latencies of the k8s workers. If datacenters are in distinct geo-locations, be sure to have low latencies between them to avoid eventual network segmentation. 

CNI providers using this network model, flannel, canal, weave...

<img src="img/encapsulated-network.svg" alt="Encapsulated network">

#### Unencapsulated 

This kind of CNI provider uses layer 3 network to route packets between containers. This model doesn't generate an isolated layer 2 network, neither generates overhead, at the cost of route distribution needed, that is managed by k8s workers. Instead of ip headers to encapsutate, it uses a bgp domain between k8s workers to distribute routing information. 

Simplifying, this network model generates a kind of network router extended between k8s workers, that provides information how to reach pods.

This network model is indeed when a routed layer 3 network is preferred. This mode dinamically update routes at os level at k8s workers. It's less sensible to latency but 

CNI providers using this network model, calico, romana...

<img src="img/unencapsulated-network.svg" alt="Unencapsulated network">

### Network Providers on Rancher

Rancher supports three different CNI providers for k8s clusters. They could be choosed when you create new k8s cluster from Rancher. 

#### Canal

<img src="img/canal-logo.png" alt="Canal logo">

Canal is a CNI provider that gives you the best of Flannel and Calico. It allows users to easily deploy Calico and flannel networking together as a unified networking solution, combining Calicoâ€™s network policy enforcement with the rich superset of Calico (unencapsulated) and/or flannel (encapsulated) network connectivity options. 

On Rancher, canal is the default CNI provider combined with flannel and vxlan encapsulation. 

K8S workers should open udp port 8472 (vxlan) and 9099 (healthcheck)

<img src="img/canal-diagram.png" alt="Canal diagram">

More info:
https://github.com/projectcalico/canal


#### flannel

<img src="img/flannel-logo.png" alt="Flannel logo">

Flannel is a simple and easy way to configure a layer 3 network fabric designed for Kubernetes. Flannel runs a single binary agent called flanneld on each host, that is responsible for allocating a subnet lease to each host out of a larger, preconfigured address space. Flannel uses either the Kubernetes API or etcd directly to store the network configuration, the allocated subnets, and any auxiliary data (such as the host's public IP). Packets are forwarded using one of several backend mechanisms, being the default encapsulation `vxlan`.

<img src="img/flannel-diagram.png" alt="Flannel diagram">

More info:
https://github.com/coreos/flannel

#### Calico 

<img src="img/calico-logo.png" alt="Calico logo">

Calico enables networking and network policy in k8s clusters across the cloud. Calico uses a pure unencapsulated IP network fabric and policy engine to provide networking solution to your k8s workloads. K8S workloads are able to peer with cloud infrastructure such as on-premise, using BGP.
Calico also provides a stateless IP-in-IP encapsulation mode that can be used, if necessary. 
Calico also offers policy isolation, allowing you to secure and govern your k8s workloads using advanced ingress and egress policies. 

<img src="img/calico-diagram.svg" alt="Calico diagram">

More info:
https://www.projectcalico.org/
https://github.com/projectcalico/calico


### Network providers summary 

Once 3 distinct CNI providers are presente, it's time to see summarize features and popularity activity on github projects.

#### Features

Here is a summary of different features of each of the CNI providers supported on Rancher.

| Provider | Network Model | Route Distribution | Network Policies | Mesh | External Datastore | Encryption | Ingress/Egress Policies | Commercial Support |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| Canal | Encapsulated (vxlan) | No | Yes | No | K8S api | No | Yes | No |
| flannel | Encapsulated (vxlan) | No | No | No | K8S api | No | No | No |
| Calico | Unencapsulated | Yes | Yes | Yes | Etcd | Yes | Yes | Yes |


- Network Model: ecnapsulated or unencapsulated. More info at CNI network model section

- Route Distribution: It is a must on Unencapsulated CNI providers, and it is typically done by BGP. Route distribution is a nice to have a feature with CNI, if you plan to build clusters split across network segments. It is an exterior gateway protocol designed to exchange routing and reachability information on the Internet. BGP can assist with pod to pod networking between clusters.

- Network Policies: K8S offers functionality to enforce rules about which service can communicate with each other using network policies. This feature is stable from k8s 1.7 and is ready to use with supported networking plugins. 

- Mesh: This feature allows service to service networking communication between distinct k8s clusters. 

- External Datastore: if CNI provider needs an external datastore to persist own data.

- Encyption: This feature allows cypher and secure network control and data planes.

- Ingress/Egress Policies: This feature allows manage routing control for k8s and Non-k8s communications.

#### Github projects

Here is a summary of different github metics to take an idea of projects popularity and activity about of each of the CNI providers supported on Rancher.

| Provider | Project | Stars | Forks | Contributors |
| ---- | ---- | ---- | ---- | ---- |
| Canal | https://github.com/projectcalico/canal | 536 | 75 | 19 |
| flannel | https://github.com/coreos/flannel | 3.279 | 774 | 107 |
| Calico | https://github.com/projectcalico/calico | 572 | 225 | 82 |

- Project: main url of the project
- Stars: Likes on GitHub
- Contributors: number of people maintaining the code base and documentation. 
- Forks: number of copies of the repo. Contributors typically have to fork the repo. Other people will fork the project to build a custom copy, push code to a feature branch that they own, or for various reasons.

Note: Tables is updated with 26th july 2018 data

### Conclussion

Which CNI provider should I use?

The above question doesn't have a trivial answer. There are many different providers, which have various features and options. There isn't one provider that meets everyones needs, and there are many different options. By the moment, at rancher v2.0.x we are supporting 3 of the major CNI providers that could be used by every user.

At rancher v2.0.x, canal is the default CNI provider. We recommend to use it in most cases. It provides encapsulated networking for containers with flannel, adding project calico network policies that can provide project/namespace isolation in temrs of networking. 

Anyway, all of 3 solutions could be a good CNI provider choose and may work perfectly fine. 






